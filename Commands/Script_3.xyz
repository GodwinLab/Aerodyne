// RUN THIS SCRIPT WHEN IT IS TIME TO CONNECT THE NEXT CO2 SAMPLE BUT YOU HAVE NO MORE SAMPLES TO CONNECT
// THIS SCRIPT MEASURES FROM THE UNSPENT FLASK WITH REF-SAMPLE SWITCHING BUT DOES NOT PREPARE A NEW MIX IN THE OTHER FLASK
				
// NOTES

				// Register 10 (R10) must contain either a 1 (ECL commands access upper flask) or 0 (ECL commands access lower flask)
				// Register 1 (R1) must contain the literal number 1
				// Register 4 (R4) must contain the literal number 4
				// Register 34 (R34) stores the dynamic valve number for flask input, either 3 or 4 (counting from 1), computed from R10
				
				// Using new ECL command: dnx,y where x is the valve state (0 or 1) or register containing the valve state (if negative) and y is the valve number (counting from 1) or register containing valve number (if negative)
				// If R10 = 1, then P19 = 1 and fill valve = E3 (valve 2 counting from 0)
				// If R10 = 0, then P19 = 0 and fill valve = E4 (valve 3 counting from 0)
				// So the P19 state is R10 and the filling valve number is R3 - R10 (counting from 0)
				// So to set P19: dn-10,19
				// and to open filling valve: cysub,34,3,10 and dn1,-34
				// and to close filling valve: cysub,34,3,10 and dn0,-34

				// Filling the intermediate volume takes about 30 sec (this happens while the cell is being measured, except the first time).
				// Evacuating the cell and transferring gas from the intermediate volume takes 30 sec.
				// Measuring the gas in the cell takes 60 sec.
				// So each cut-and-paste cycle takes 180 sec.
				// So the total time is about 30 + n*180 + 90 sec = 120 + n*180 sec, where n is the number of sample-ref cell fill pairs apart from the final ref fill.
				// So to allow 30 min = 1800 sec for the flask to mix, we want 1800 = 120 + n*180 => n = 1680/180 = 9.33.
				// So we will do 10 cycles and thereby allow each flask to mix for 32 minutes.

				// THIS BLOCK TOGGLES WD OFF AND ON TO MAKE A SEPARATE FILE FOR EACH PURE CO2 SAMPLE
amwd0			// turn off wd
bc1				// wait 1 sec
amwd1			// turn on wd

				// THIS BLOCK STARTS A 1-SECOND DUMMY TIMER, JUST TO ALLOW FOR SIMPLE COPY-AND-PASTING OF SCRIPT 4 BELOW
cr1				// start a 1-second timer
				
				// THIS BLOCK DOES THE SWITCHER CYCLES (EACH dd4 COMMAND WILL DO ONE REF-SAMPLE CYCLE)
dd4				// runs script 4, which does one switcher cycle (fill int vol with ref, transfer that to cell and measure, fill int vol with sample, transfer that to cell and measure)
dd4				// runs script 4, which does one switcher cycle (fill int vol with ref, transfer that to cell and measure, fill int vol with sample, transfer that to cell and measure)
dd4				// runs script 4, which does one switcher cycle (fill int vol with ref, transfer that to cell and measure, fill int vol with sample, transfer that to cell and measure)
dd4				// runs script 4, which does one switcher cycle (fill int vol with ref, transfer that to cell and measure, fill int vol with sample, transfer that to cell and measure)
dd4				// runs script 4, which does one switcher cycle (fill int vol with ref, transfer that to cell and measure, fill int vol with sample, transfer that to cell and measure)
dd4				// runs script 4, which does one switcher cycle (fill int vol with ref, transfer that to cell and measure, fill int vol with sample, transfer that to cell and measure)
dd4				// runs script 4, which does one switcher cycle (fill int vol with ref, transfer that to cell and measure, fill int vol with sample, transfer that to cell and measure)
dd4				// runs script 4, which does one switcher cycle (fill int vol with ref, transfer that to cell and measure, fill int vol with sample, transfer that to cell and measure)
dd4				// runs script 4, which does one switcher cycle (fill int vol with ref, transfer that to cell and measure, fill int vol with sample, transfer that to cell and measure)
dd4				// runs script 4, which does one switcher cycle (fill int vol with ref, transfer that to cell and measure, fill int vol with sample, transfer that to cell and measure)

dmFilling_intermediate_volume_with_ref // status message in popup window

				// THIS BLOCK FILLS THE INTERMEDIATE VOLUME WITH REF ONE FINAL TIME (TO BRACKET ALL SAMPLES WITH REF)
dno14			// open valve P14 (switcher vac)
dno12			// open valve P12 (intermediate volume)
bc20			// pump 20 seconds on intermediate volume
dnc12			// close valve P12 (intermediate volume)
dnc14			// close valve P14 (switcher vac)
azb1,2,150		// fill via valve E2 (ref orifice) until gauge 2 (intermediate volume) reaches 150 torr
bc60       		// special use of bc: 60 sec timeout for the azb command on the previous line
dmWaiting_for_sample_measurement_to_complete // status message in popup window
cr				// wait for the timer we started

dmTransferring_ref_into_cell // status message in popup window

				// THIS BLOCK TRANSFERS REF FROM THE INTERMEDIATE VOLUME TO THE CELL ONE FINAL TIME (TO BRACKET ALL SAMPLES WITH REF)
ca0				// suspend ecl index
bdFits1			// suspend fitting
dnc12			// shut intermediate volume
dno14			// open vac valve
dno15			// open cell valve	
bc25			// wait 25 seconds to pump
dnc14			// shut vac valve
bc1				// wait 1 seconds
dno12			// open intermediate volume, expand gas into cell
bc4				// wait 4 seconds to expand gas into cell
dnc15			// shut cell, measurement runs
dnc12			// close intermediate volume
bz2				// defines ecl index = 2 (ref)
ca1				// executes ecl index
bdFits0			// restarts fitting
cr60			// start a 60-second timer

dmWaiting_for_final_ref_measurement // status message in popup window

				// THIS BLOCK WAITS FOR THE FINAL REF MEASUREMENT TO COMPLETE
cr				// wait for the timer we started

				// THIS BLOCK TOGGLES WD OFF AND ON TO MAKE A SEPARATE FILE FOR EACH PURE CO2 SAMPLE
amwd0			// turn off wd
bc1				// wait 1 sec
amwd1			// turn on wd

				// THIS BLOCK DEACTIVATES ALL VALVES
//bq0			// close all valves and deactivate the 3-way valve, which sets it to the lower flask
dnc1			// close E1
dnc2			// close E2
dnc3			// close E3
dnc4			// close E4
dnc5			// close E5
dnc9			// close P9
dnc10			// close P10
dnc11			// close P11
dnc12			// close P12
dnc13			// close P13
dnc14			// close P14
dnc15			// close P15
dnc17			// close P17
dnc18			// close P18
dnc19			// set 3-way valve to lower flask

dmRun_complete // put up message window to prompt the user